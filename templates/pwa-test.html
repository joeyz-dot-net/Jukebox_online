<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA æµ‹è¯• - ClubVoice</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#16213e">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
        }
        h1 {
            margin-bottom: 20px;
            color: #2ecc71;
        }
        h2 {
            margin-top: 30px;
            margin-bottom: 15px;
            color: #3498db;
            font-size: 1.3rem;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        .status-card.success { border-color: #2ecc71; }
        .status-card.error { border-color: #e74c3c; }
        .status-card.warning { border-color: #f39c12; }
        .label {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 5px;
        }
        .value {
            font-size: 1.1rem;
            font-weight: bold;
        }
        .btn {
            background: #2ecc71;
            border: none;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        .log-container {
            background: #000;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        .log-entry {
            margin-bottom: 4px;
        }
        .log-entry.success { color: #2ecc71; }
        .log-entry.error { color: #e74c3c; }
        .log-entry.info { color: #3498db; }
        .log-entry.warn { color: #f39c12; }
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .icon-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .icon-item img {
            width: 100%;
            height: auto;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        .icon-item .size {
            font-size: 0.75rem;
            color: #888;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ PWA åŠŸèƒ½æµ‹è¯•</h1>
        <p><a href="/">â† è¿”å›ä¸»é¡µé¢</a></p>

        <h2>ğŸ“± PWA æ”¯æŒçŠ¶æ€</h2>
        <div class="status-grid" id="statusGrid"></div>

        <h2>ğŸ¯ åŠŸèƒ½æµ‹è¯•</h2>
        <div>
            <button class="btn" id="btnInstall">ğŸ“¥ å®‰è£… PWA</button>
            <button class="btn" id="btnUnregister">ğŸ—‘ï¸ æ³¨é”€ Service Worker</button>
            <button class="btn" id="btnRefresh">ğŸ”„ åˆ·æ–°ç¼“å­˜</button>
            <button class="btn" id="btnTest">ğŸ§ª æµ‹è¯•åŠŸèƒ½</button>
        </div>

        <h2>ğŸ–¼ï¸ å›¾æ ‡èµ„æº</h2>
        <div class="icon-grid" id="iconGrid"></div>

        <h2>ğŸ“‹ æ—¥å¿—</h2>
        <div class="log-container" id="logContainer"></div>
    </div>

    <script>
        // æ—¥å¿—åŠŸèƒ½
        function log(msg, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${msg}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${msg}`);
        }

        // æ£€æµ‹ PWA æ”¯æŒ
        function checkPWASupport() {
            const checks = [
                {
                    label: 'Service Worker',
                    value: 'serviceWorker' in navigator,
                    desc: 'Service Worker API'
                },
                {
                    label: 'Manifest',
                    value: true, // ä¼šå¼‚æ­¥æ£€æŸ¥
                    desc: 'Web App Manifest',
                    async: true
                },
                {
                    label: 'Cache API',
                    value: 'caches' in window,
                    desc: 'ç¼“å­˜å­˜å‚¨'
                },
                {
                    label: 'MediaSession',
                    value: 'mediaSession' in navigator,
                    desc: 'åª’ä½“ä¼šè¯æ§åˆ¶'
                },
                {
                    label: 'Notifications',
                    value: 'Notification' in window,
                    desc: 'æ¨é€é€šçŸ¥'
                },
                {
                    label: 'Standalone Mode',
                    value: window.matchMedia('(display-mode: standalone)').matches,
                    desc: 'PWA ç‹¬ç«‹æ¨¡å¼'
                },
                {
                    label: 'iOS',
                    value: /iPad|iPhone|iPod/.test(navigator.userAgent),
                    desc: 'iOS è®¾å¤‡'
                },
                {
                    label: 'HTTPS',
                    value: location.protocol === 'https:' || location.hostname === 'localhost',
                    desc: 'å®‰å…¨è¿æ¥'
                }
            ];

            const grid = document.getElementById('statusGrid');
            
            // å…ˆæ˜¾ç¤ºåŒæ­¥æ£€æŸ¥ç»“æœ
            checks.forEach(check => {
                const card = document.createElement('div');
                // ä½¿ç”¨å®‰å…¨çš„ IDï¼ˆç§»é™¤ç©ºæ ¼ï¼‰
                const safeId = check.label.replace(/\s+/g, '-');
                card.id = `check-${safeId}`;
                card.className = `status-card ${check.async ? '' : (check.value ? 'success' : 'warning')}`;
                card.innerHTML = `
                    <div class="label">${check.desc}</div>
                    <div class="value">${check.async ? 'â³ æ£€æµ‹ä¸­...' : (check.value ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ')}</div>
                `;
                grid.appendChild(card);
                
                if (!check.async) {
                    log(`${check.label}: ${check.value ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`, check.value ? 'success' : 'warn');
                }
            });
            
            // å¼‚æ­¥æ£€æŸ¥ Manifest
            checkManifest();
        }
        
        // å¼‚æ­¥æ£€æŸ¥ manifest
        async function checkManifest() {
            const card = document.getElementById('check-Manifest');
            try {
                const response = await fetch('/manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    if (manifest.name && manifest.icons) {
                        card.className = 'status-card success';
                        card.querySelector('.value').textContent = 'âœ… æ”¯æŒ';
                        log(`Manifest: åŠ è½½æˆåŠŸ - ${manifest.name}`, 'success');
                    } else {
                        throw new Error('Manifest æ ¼å¼ä¸å®Œæ•´');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (e) {
                card.className = 'status-card warning';
                card.querySelector('.value').textContent = 'âŒ ä¸æ”¯æŒ';
                log(`Manifest: åŠ è½½å¤±è´¥ - ${e.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºå›¾æ ‡
        function showIcons() {
            const sizes = [72, 96, 128, 144, 152, 192, 384, 512];
            const grid = document.getElementById('iconGrid');
            
            sizes.forEach(size => {
                const item = document.createElement('div');
                item.className = 'icon-item';
                item.innerHTML = `
                    <img src="/static/icon-${size}.png" alt="${size}x${size}" onerror="this.style.display='none'">
                    <div class="size">${size}Ã—${size}</div>
                `;
                grid.appendChild(item);
            });
        }

        // å®‰è£… PWA
        let deferredPrompt = null;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            log('å¯ä»¥å®‰è£… PWA', 'success');
            document.getElementById('btnInstall').disabled = false;
        });

        document.getElementById('btnInstall').addEventListener('click', async () => {
            if (!deferredPrompt) {
                log('æ— æ³•å®‰è£…ï¼šæœªæ£€æµ‹åˆ°å®‰è£…æç¤º', 'error');
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                log('ç”¨æˆ·æ¥å—å®‰è£… PWA', 'success');
            } else {
                log('ç”¨æˆ·æ‹’ç»å®‰è£… PWA', 'warn');
            }
            
            deferredPrompt = null;
            document.getElementById('btnInstall').disabled = true;
        });

        // æ³¨é”€ Service Worker
        document.getElementById('btnUnregister').addEventListener('click', async () => {
            if (!('serviceWorker' in navigator)) {
                log('æµè§ˆå™¨ä¸æ”¯æŒ Service Worker', 'error');
                return;
            }
            
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (let registration of registrations) {
                await registration.unregister();
                log('å·²æ³¨é”€ Service Worker: ' + registration.scope, 'success');
            }
            
            if (registrations.length === 0) {
                log('æ²¡æœ‰æ‰¾åˆ°å·²æ³¨å†Œçš„ Service Worker', 'info');
            }
        });

        // åˆ·æ–°ç¼“å­˜
        document.getElementById('btnRefresh').addEventListener('click', async () => {
            if (!('caches' in window)) {
                log('æµè§ˆå™¨ä¸æ”¯æŒ Cache API', 'error');
                return;
            }
            
            const cacheNames = await caches.keys();
            for (let name of cacheNames) {
                await caches.delete(name);
                log('å·²åˆ é™¤ç¼“å­˜: ' + name, 'success');
            }
            
            if (cacheNames.length === 0) {
                log('æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜', 'info');
            } else {
                log('åˆ·æ–°é¡µé¢ä»¥é‡æ–°ç¼“å­˜èµ„æº', 'info');
            }
        });

        // æµ‹è¯•åŠŸèƒ½
        document.getElementById('btnTest').addEventListener('click', async () => {
            log('å¼€å§‹æµ‹è¯•...', 'info');
            
            // æµ‹è¯• Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/static/sw.js');
                    log('Service Worker æ³¨å†ŒæˆåŠŸ', 'success');
                    
                    // å‘é€æµ‹è¯•æ¶ˆæ¯
                    if (registration.active) {
                        const messageChannel = new MessageChannel();
                        messageChannel.port1.onmessage = (event) => {
                            if (event.data.type === 'PONG') {
                                log('Service Worker å“åº”æ­£å¸¸', 'success');
                            }
                        };
                        
                        registration.active.postMessage(
                            { type: 'KEEP_ALIVE' },
                            [messageChannel.port2]
                        );
                    }
                } catch (err) {
                    log('Service Worker æ³¨å†Œå¤±è´¥: ' + err.message, 'error');
                }
            }
            
            // æµ‹è¯• Manifest
            try {
                const response = await fetch('/static/manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    log(`Manifest åŠ è½½æˆåŠŸ: ${manifest.name}`, 'success');
                } else {
                    log('Manifest åŠ è½½å¤±è´¥: ' + response.status, 'error');
                }
            } catch (err) {
                log('Manifest åŠ è½½å¤±è´¥: ' + err.message, 'error');
            }
            
            // æµ‹è¯•å›¾æ ‡
            const testIcon = new Image();
            testIcon.onload = () => log('å›¾æ ‡åŠ è½½æˆåŠŸ: icon-192.png', 'success');
            testIcon.onerror = () => log('å›¾æ ‡åŠ è½½å¤±è´¥: icon-192.png', 'error');
            testIcon.src = '/static/icon-192.png';
            
            log('æµ‹è¯•å®Œæˆ', 'info');
        });

        // åˆå§‹åŒ–
        window.onload = () => {
            log('PWA æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            checkPWASupport();
            showIcons();
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥å®‰è£…
            document.getElementById('btnInstall').disabled = true;
            if (window.matchMedia('(display-mode: standalone)').matches) {
                log('å½“å‰è¿è¡Œåœ¨ PWA ç‹¬ç«‹æ¨¡å¼', 'success');
            }
        };
    </script>
</body>
</html>
